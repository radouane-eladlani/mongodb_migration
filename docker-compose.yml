version: "3.8"

services:
  # -----------------------------
  # Conteneur MongoDB
  # -----------------------------
  mongodb:
    image: mongo:6.0
    container_name: mongodb_local
    ports:
      - "27017:27017"                  # Expose le port MongoDB sur l'hôte
    environment:
      MONGO_INITDB_ROOT_USERNAME: data_engineer
      MONGO_INITDB_ROOT_PASSWORD: password123
      MONGO_INITDB_DATABASE: hopital
    volumes:
      - mongo_data:/data/db            # Stockage persistant des données MongoDB
      - ./healthcare_dataset.csv:/data/csv/healthcare_dataset.csv  # CSV à migrer
    restart: unless-stopped            # Redémarre automatiquement sauf arrêt manuel

  # -----------------------------
  # Test d'intégrité avant migration
  # -----------------------------
  test_before:
    build: .
    container_name: test_before_app
    # Exécuter Pytest sur les tests d'intégrité avant migration
    command: pytest test_integrity_before.py
    volumes:
      - ./healthcare_dataset.csv:/app/healthcare_dataset.csv

  # -----------------------------
  # Conteneur de migration CSV → MongoDB
  # -----------------------------
  migration:
    build: .
    container_name: migration_app
    depends_on:
      - mongodb                      # Attend que MongoDB soit opérationnel
    command: >
      sh -c "
        echo 'Attente du démarrage de MongoDB...' &&
        sleep 10 &&
        echo 'Lancement du script de migration...' &&
        python migrate.py
      "

  # -----------------------------
  # Test d'intégrité après migration
  # -----------------------------
  test_after:
    build: .
    container_name: test_after_app
    depends_on:
      - mongodb
      - migration                     # Attend que MongoDB et la migration soient terminés
    # Exécuter Pytest sur les tests d'intégrité après migration
    command: pytest test_integrity_after.py

# -----------------------------
# Volumes persistants
# -----------------------------
volumes:
  mongo_data:                         # Persiste les données MongoDB même après arrêt du conteneur
